---
title: "Your Project: Data Preparation" 

author:
    - name: ""
      url: 
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
      orcid_id: 
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate
        code_folding: false  
        toc: true            
        toc_depth: 2         
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE,
                      fig.width = 9, fig.height = 6, dpi = 500, 
                      retina = 1, fig.showtext = TRUE)
```

# Setup

```{r packages}
# devtools::install_github("EcoDynIZW/d6")
# devtools::install_github("EcoDynIZW/d6geodata")

sapply(list("sf", "tidyverse", "terra", "here" , "d6geodata", "d6", "DBI", "rpostgis"), 
       library, character.only = TRUE, logical.return = TRUE)
```

# create folder

```{r path}
data_name <- d6geodata::data_name()

path <- here("data", unlist(str_split(data_name, "_"))[2], data_name)

dir.create(path = here::here(path))
```

# Data

```{r data}
(germany_3035_sf <- st_read(here("data", 
                                 "germany",
                                 "administrativ-units_germany_2020_polygon_28532_gpkg",
                                 "administrativ-units_germany_2020_polygon_28532.gpkg")) %>% 
   dplyr::select(GEN) %>% 
   st_transform(3035)
 )

berlin_3035_sf <-
  st_read(
    here(
      "data",
      "berlin",
      "districs_berlin_2022_poly_03035_gpkg",
      "districs_berlin_2022_poly_03035.gpkg"
    )
  )

```

# processing

```{r processing}
tif <- 

terra::writeRaster(tif, here(path, stringi::stri_replace_last_fixed(data_name, "_", ".")), overwrite = TRUE)
```

# create meta data file

```{r meatadata}
meta <- dplyr::tibble(
  folder_name = data_name,
  name = stringi::stri_replace_last_fixed(data_name, "_", "."),
  epsg = d6geodata:::fun_l_epsg(),
  crs = sf::st_crs(ifelse(epsg_in %in% 54009, "ESRI:54009", paste0("EPSG:", epsg_in)))$proj4string,
  year_of_data = ,
  units_of_data = "",
  resolution = "",
  type_of_data = d6geodata:::fun_type(),
  type_of_file = d6geodata:::fun_file(),
  date_of_compile = as.character(Sys.Date()),
  source = d6geodata:::fun_source(),
  short_description = "",
  modified = NA
) |> 
   mutate(link_of_source = d6geodata:::fun_source_link(x = source),
          copyright = d6geodata:::get_copyright(source))


write.table(meta, base::paste0(path, "/meta-data_", 
    data_name, ".csv"), row.names = FALSE, sep = ",")
```

# plot file

```{r}
tif_plot <- tif

if(meta$type_of_data == 'binary_categorical') {
  p_map <- d6geodata::plot_binary_map(tif = tif_plot)
  }
if(meta$type_of_data %in% c('continuous_numeric', 'discrete_numeric')) {
  p_map <- d6geodata::plot_quantitative_map(tif = tif_plot)
}
if(meta$type_of_data %in% c('unordered_categorical', 'ordered_categorical')) {
  p_map <- d6geodata::plot_qualitative_map(tif = tif_plot)
}

saveRDS(p_map, here(path, paste0(data_name, ".rds")))
```

# create html file

```{r html}
d6geodata::create_report(path_name = data_name, out_path = paste0(stringi::stri_c((
      unlist(stringi::stri_split(path, regex = "/"))[-c(1:which(unlist(stringi::stri_split(path, regex = "/")) %in% "GeoData")-1)]
    ), collapse = "/")), cats = c())
```

# add to geodatabase

## connect to database

```{r}
source("geodatamanager.R")

con <- dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password)  

dbExecute(con, "SET search_path TO geodata")
```


```{r}
meta$type <- ifelse(grepl(".tif", meta$name), "raster", stringr::str_split(meta$name, "_")[[1]][4])
meta$region <- stringr::str_split(meta$name, "_")[[1]][2]

meta$sub_name <- paste0(str_c(stringr::str_split(meta$folder_name, "_")[[1]] %>% str_sub(1,2), collapse = ""))

meta$geo_id <- NA

dbExecute(con, glue::glue("
  INSERT INTO geodata.metadata (sub_name, folder_name, name, type, region, crs, epsg, year_of_data,
  units_of_data, resolution, type_of_data, type_of_file, source, link_of_source,
  date_of_compile, copyright, short_description, modified)
  VALUES (
  '{meta$sub_name}',
  '{meta$folder_name}',
  '{meta$name}',
  '{meta$type}',
  '{meta$region}',
  '{meta$crs}',
  '{meta$epsg}',
  '{meta$year_of_data}',
  '{meta$units_of_data}',
  '{meta$resolution}',
  '{meta$type_of_data}',
  '{meta$type_of_file}',
  '{meta$source}',
  '{meta$link_of_source}',
  '{meta$date_of_compile}',
  '{meta$copyright}',
  '{meta$short_description}',
  '{meta$modified}')
"))

id <- dbGetQuery(con, glue::glue("SELECT geo_id FROM geodata.metadata ORDER BY geo_id DESC LIMIT 1;"))

meta$sub_name <- paste0(str_c(stringr::str_split(meta$folder_name, "_")[[1]] %>% str_sub(1,2), collapse = ""), id)

dbGetQuery(con, glue::glue("UPDATE metadata SET sub_name='",meta$sub_name,"' WHERE geo_id=",id$geo_id,";"))

# check number of layers and use the last one
if(nlyr(tif) >= 10){
      tif <- data[[nlyr(tif)]]
      meta$short_description <- "there where several layers and only the last one was used."
      dbGetQuery(con, glue::glue("UPDATE geodata.metadata 
                                 SET modified='there where several layers and only the last one was used. Please contact the database manager to get the more or all layers' 
                                 WHERE sub_name= '",meta$sub_name,"' ;"))
      
    }

# cheack if number of cells is to large

    if(ncell(tif) >= 50e+6){
      
    nxy <- ceiling(ncell(tif)/50e+6/2)
    
    data_split <- SpaDES.tools::splitRaster(tif, ny = nxy, nx = nxy)
    
    # data_split <- lapply(data_split, function(x){
    #   return(crs(x) <- crs(data))})
    
    lapply(data_split, function(ras){
      rpostgis::pgWriteRast(conn = con,
                      name = c("geodata", meta$sub_name),
                      raster = ras,
                      append = TRUE,
                      overwrite = TRUE,
                      constraint = TRUE,
                      blocks = NULL,
                      bit.depth = NULL)

    }) 
    } else{
    
    rpostgis::pgWriteRast(conn = con,
                      name = c("geodata", meta$sub_name),
                      raster = tif,
                      append = TRUE,
                      overwrite = TRUE,
                      constraint = TRUE,
                      blocks = NULL,
                      bit.depth = NULL)
      
    }

   dbExecute(con, glue::glue("ALTER TABLE geodata.",
                              meta$sub_name,
                              " ADD geo_id integer NULL"))

    dbExecute(con, glue::glue("UPDATE geodata.",
                              meta$sub_name,
                              " SET geo_id = ",
                              id$geo_id))


rpostgis::dbAddKey(
  conn = con,
  name = c("geodata",meta$sub_name),
  colname = "geo_id",
  type = c("foreign"),
  reference = c("geodata", "metadata"),
  colref = "geo_id",
  display = TRUE,
  exec = T)

 dbExecute(con, glue::glue("GRANT SELECT ON TABLE geodata.", meta$sub_name," TO gis_d6;"))



```

***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>

